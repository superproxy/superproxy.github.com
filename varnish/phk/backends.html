<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>‘backend’是什么意思？ &mdash; varnish 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="varnish 1.0.1 documentation" href="../index.html" />
    <link rel="up" title="Poul-Hennings random outb.txts" href="index.html" />
    <link rel="next" title="Picking platforms" href="platforms.html" />
    <link rel="prev" title="IPv6 Suckage" href="ipv6suckage.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="platforms.html" title="Picking platforms"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ipv6suckage.html" title="IPv6 Suckage"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">varnish 1.0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Poul-Hennings random outb.txts</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="backend">
<span id="phk-backends"></span><h1>&#8216;backend&#8217;是什么意思？<a class="headerlink" href="#backend" title="Permalink to this headline">¶</a></h1>
<p>鉴于我们正在完成Varnish 3.0版本，大家可能认为很久前我就坚定地回答了这个问题，但是当你尝试变得高效时，事情也会变得棘手。</p>
<p>在基础层面，我们关注Varnish的一个功能是多VCLS同时加载的能力，并在他们之间能够及时快速切换。</p>
<p>你可以想想在VCL里面有1000台后端服务器，都是配置正确且含有健康检查配置的服务器。</p>
<p>现在你仅修改了一点点vcl_recv{}，然后重新加载VCL，此时你也不确认哪种方式来解决这种情况，结果是保持了两种VCL加载，所以你可以在来回进行无缝切换。</p>
<p>为了达到无缝切换的目的，在我们切换到其他VCL的瞬间，每一个后端的健康状态需要处于最新。</p>
<p>这基本上意味着，要么全部VCL轮训所有的后端或者他们之间做到共享。</p>
<p>我们可以关闭所有VCL轮训所有后端的方案，因为这样确实很可怕，如果有人忘记在旧VCL里面使用vcl.discard，那么探测会持续进行。</p>
<div class="section" id="id1">
<h2>分享、欣赏<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>除了健康状况外（包括saint列表）, 我们也会共享打开的缓存连接数和统计数。</p>
<p>断开与后端的100个准备好的或可使用的连接，打开100个其他的，在一个拥有相同后端定义不同的VCL间做切换，这样做是不明智的。</p>
<p>在这种情况下什么样属于有相同的后端定义？</p>
<p>重要的是要明晰我们不是在讨论物理后端：举例说，拥有相同后端，却没有什么防护的VCL可以认为是4个不同后端。</p>
<p>最明显的事，可以通过使用VCL名字作为后端定义，但这还不够。我们可以有两套不同的VCL组成，当迁移或升级后端时，可以将&#8221;b&#8221;指向两个不同的物理机。</p>
<dl class="docutils">
<dt>因此有三种可以共享的状态定义：</dt>
<dd>{VCL-name, IPv4+port, IPv6+port}</dd>
</dl>
</div>
<div class="section" id="id2">
<h2>如果不能很好的展示信息，信息就毫无价值<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>一旦健康状态在这些定义中存在，我们就需要在CLI中找到一种方式代表他们能做前后统计。</p>
<p>尽管我们可以把结果输出，虽然不是什么大不了的事，但是如果你想要1000台后端中一台的健康状况，你如何告诉我是那一台？</p>
<p>这样做的方式强制人们每次都输入:</p>
<div class="highlight-python"><div class="highlight"><pre>backend.health b1(127.0.0.1:8080,[::1]:8080)
</pre></div>
</div>
<p>我确认那些只有一个后端的人不会命中。</p>
<p>我想即使我实现了我也不会承认，你可以这样书写通配符混杂方案:</p>
<div class="highlight-python"><div class="highlight"><pre>b1                     # 仅有一个b1后端或错误

b1()                            # 所有命名b1的后端

b1(127.0.0.1)           # 所有基于IPv4本地检测的b1

b1(:8080)                                  # 监听在8080的所有b1, (IPv4或IPv6)

b1(192.168.60.1,192.168.60.2)   # 基于地址的所有b1
</pre></div>
</div>
<p>(受欢迎的输入)</p>
<p>最后一个问题，如果我们使用快捷符号输出Varnishd，答案是No。因为我们不想让计数器修改名字，当我们需要加载另一个VCL和突然要消除问题。</p>
</div>
<div class="section" id="id3">
<h2>共享健康状况<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>为了避免过度轮训，我们定义一个VCL同时对后端的最大轮训，并且灵活的VCL也受到偏爱。哪个特定的VCL轮训后端在灵活的VCL中是不重要的，只要他们之中一个可以实现就可以。</p>
</div>
<div class="section" id="id4">
<h2>实施<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>基于vcl.use的执行，对后端的轮训规范可以通过更新后端指针的轮训策略实现。</p>
<p>关于vcl.discard，如果这个vcl是有效状态的轮询器，那它需要遍历所有vcl列表，找到一个vcl进行替换；如果vcl列表是空的，那后端就会被移除。</p>
<p>我们或者在每个后端放一个线程，或者放一个轮训线程，当后端需要轮训时它能进到work池中扔掉在做的事。</p>
<p>匹配模式局限与在CLI和可能的libvarnishapi。</p>
<p>我想这可以工作，</p>
<p>下次再说,</p>
<p>Poul-Henning, 2010-08-09</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">&#8216;backend&#8217;是什么意思？</a><ul>
<li><a class="reference internal" href="#id1">分享、欣赏</a></li>
<li><a class="reference internal" href="#id2">如果不能很好的展示信息，信息就毫无价值</a></li>
<li><a class="reference internal" href="#id3">共享健康状况</a></li>
<li><a class="reference internal" href="#id4">实施</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="ipv6suckage.html"
                        title="previous chapter">IPv6 Suckage</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="platforms.html"
                        title="next chapter">Picking platforms</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/phk/backends.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="platforms.html" title="Picking platforms"
             >next</a> |</li>
        <li class="right" >
          <a href="ipv6suckage.html" title="IPv6 Suckage"
             >previous</a> |</li>
        <li><a href="../index.html">varnish 1.0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Poul-Hennings random outb.txts</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, sens.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>